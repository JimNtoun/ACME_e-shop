#table creation
create.table.customer=\
	CREATE TABLE CUSTOMER (\
		"ID" NUMBER NOT NULL ENABLE, \
		"FNAME" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		"LNAME" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		"EMAIL" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		"PHONE" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		"ADDRESS" VARCHAR2(100 BYTE) NOT NULL ENABLE, \
		"CITY" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		"CATEGORY" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		CONSTRAINT "CUSTOMERS_CHK1" CHECK (category IN ('B2C', 'B2B', 'B2G')) ENABLE, \
		CONSTRAINT "CUSTOMER_PK" PRIMARY KEY ("ID")\
		)

create.table.product=\
	CREATE TABLE PRODUCTS (\
  		"ID" NUMBER NOT NULL ENABLE, \
		PNAME VARCHAR2(100 BYTE) NOT NULL ENABLE, \
		PRICE NUMBER(*,0) NOT NULL ENABLE, \
		CONSTRAINT "PRODUCTS_PK" PRIMARY KEY ("ID")\
		CONSTRAINT "PRODUCTS_UK1" UNIQUE ("PNAME")\
		)

create.table.order=\
	CREATE TABLE ORDERS (\
		"ID" NUMBER NOT NULL ENABLE, \
		"STATUS" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		"ORDERDATE" DATE NOT NULL ENABLE, \
		"PAYMENT" VARCHAR2(50 BYTE) NOT NULL ENABLE, \
		"CUSTID" NUMBER NOT NULL ENABLE, \
		"COST" FLOAT(126), \
		CONSTRAINT "ORDERS_CHK1" CHECK (payment IN ('Cash', 'Card')) ENABLE, \
		CONSTRAINT "ORDERS_CHK2" CHECK (status IN ('Pending', 'Delivered')) ENABLE, \
		CONSTRAINT "ORDERS_PK" PRIMARY KEY ("ID")\
		CONSTRAINT "ORDERS_FK1" FOREIGN KEY ("CUSTID")\
			REFERENCES "CUSTOMERS" ("ID") ENABLE\
		)

create.table.orderItem=\
	CREATE TABLE ORDERITEMS (\
		"ID" NUMBER NOT NULL ENABLE,\
		"ORDERID" NUMBER NOT NULL ENABLE,\
		"QUANTITY" NUMBER(*,0) NOT NULL ENABLE, \
		CONSTRAINT "ORDERITEMS_PK" PRIMARY KEY ("ID")\
		CONSTRAINT "ORDERITEMS_FK1" FOREIGN KEY ("ORDERID")\
			REFERENCES "ORDERS" ("ID") ENABLE \
		)


#some data to work with
#INSERT INTO customers(FNAME, LNAME, EMAIL, PHONE, ADDRESS, CITY, CATEGORY)
#VALUES('Tom', 'Hanks', 'fff@gmail.com', '6980000001', '...', 'Athens', 'B2B');
#INSERT INTO customers(FNAME, LNAME, EMAIL, PHONE, ADDRESS, CITY, CATEGORY)
#VALUES('Bob', 'Marley', 'pg@gmail.com', '6980000002', '...', 'Athens', 'B2C');
#INSERT INTO customers(FNAME, LNAME, EMAIL, PHONE, ADDRESS, CITY, CATEGORY)
#VALUES('Ben', 'Affleck', 'sth@gmail.com', '6980000003', '...', 'Athens', 'B2G');

#INSERT INTO products(pname, price)
#VALUES('A', 30);
#INSERT INTO products(pname, price)
#VALUES('B', 40);
#INSERT INTO products(pname, price)
#VALUES('C', 50);
#INSERT INTO products(pname, price)
#VALUES('D', 100);
#INSERT INTO products(pname, price)
#VALUES('E', 10);
#INSERT INTO products(pname, price)
#VALUES('CC', 70);

#INSERT INTO orders(status, orderdate, payment, custid)
#VALUES('Pending', DATE '2022-07-27', 'Card', 3);
#INSERT INTO orders(status, orderdate, payment, custid)
#VALUES('Pending', DATE '2022-07-28', 'Cash', 1);
#INSERT INTO orders(status, orderdate, payment, custid)
#VALUES('Delivered', DATE '2022-07-28', 'Cash', 1);
#INSERT INTO orders(status, orderdate, payment, custid)
#VALUES('Pending', DATE '2022-07-28', 'Card', 2);

#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(1, 'B', 4);
#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(2, 'CC', 1);
#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(3, 'D', 2);
#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(4, 'B', 5);
#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(1, 'A', 6);
#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(2, 'C', 2);
#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(3, 'CC', 7);
#INSERT INTO orderitems(orderid, pname, quantity)
#VALUES(4, 'E', 5);

#Reports requested
#Total number and cost of purchases for a particular customer
select.table.000 = \
	SELECT SUM(orders.cost) AS total_cost,\
	COUNT(orders.id) AS total_purchases\
	FROM products, orders, orderitems, customers\
	WHERE (customers.id = ? AND customers.id = orders.custid \
	AND orders.id = orderitems.orderid\
	AND products.pname = orderitems.pname AND orders.status = 'Delivered')

#Total number and cost of purchases for a particular product
select.table.001 =\
	SELECT SUM(orders.cost) AS total_cost,\
	COUNT(orders.id) AS total_purchases\
	FROM products, orders, orderitems\
	WHERE (products.id = ? AND orders.id = orderitems.orderid\
	AND products.pname = orderitems.pname AND orders.status = 'Delivered')

#Total number and cost of purchases per customer
select.table.002 =\
	SELECT customers.id,\
	customers.fname AS first_name,\
	customers.lname AS last_name,\
	SUM(orders.cost) AS total_cost,\
	COUNT(orders.id) AS total_purchases\
	FROM products, orders, orderitems, customers\
	WHERE (customers.id = orders.custid AND orders.id = orderitems.orderid\
	AND products.pname = orderitems.pname AND orders.status = 'Delivered')\
	GROUP BY customers.id, customers.fname, customers.lname\
	ORDER BY customers.id

#Total number and cost of purchases per customer category
select.table.003 =\
	SELECT customers.category,\
	SUM(orders.cost) AS total_cost,\
	COUNT(orders.id) AS total_purchases\
	FROM products, orders, orderitems, customers\
	WHERE (customers.id = orders.custid AND customers.id = customers.id\
	AND orders.id = orderitems.orderid\
	AND products.pname = orderitems.pname AND orders.status = 'Delivered')\
	GROUP BY customers.category

#Total number and cost of purchases per payment method
select.table.004 = \
	SELECT orders.payment,\
	SUM(orders.cost) AS total_cost,\
	COUNT(orders.id) AS total_purchases\
	FROM products, orders, orderitems, customers\
	WHERE (customers.id = orders.custid AND customers.id = customers.id\
	AND orders.id = orderitems.orderid\
	AND products.pname = orderitems.pname AND orders.status = 'Delivered')\
	GROUP BY orders.payment

#Average order cost
select.table.005 = \
	SELECT AVG(cost) AS average_order_cost\
	FROM orders\
	WHERE status = 'Delivered'

#Average order cost per customer
select.table.006 = \
	SELECT customers.id,\
	customers.fname AS first_name,\
	customers.lname AS last_name,\
	AVG(orders.cost) AS average_order_cost\
	FROM products, orders, orderitems, customers\
	WHERE (customers.id = orders.custid AND orders.id = orderitems.orderid\
	AND products.pname = orderitems.pname AND orders.status = 'Delivered')\
	GROUP BY customers.id, customers.fname, customers.lname\
	ORDER BY customers.id

#The customer(s) who purchased the most expensive product and how many times
select.table.007 = \
	SELECT customers.id,\
	customers.fname AS first_name,\
	customers.lname AS last_name,\
	SUM(orderitems.quantity) AS total_products_bought\
	FROM products, orders, orderitems, customers\
	WHERE (customers.id = orders.custid AND orders.id = orderitems.orderid\
	AND products.price = (SELECT DISTINCT MAX(price) FROM products)\
	AND products.pname = orderitems.pname AND orders.status = 'Delivered')\
	GROUP BY customers.id, customers.fname, customers.lname\
	ORDER BY customers.id

#IMPORTANT!!!
#1	column COST of ORDERS needs update method for when an order is made
#2	{COUNT(orders.id) AS total_purchases} can be replaced by
#	{SUM(orderitems.quantity) AS total_products_bought}...needs discussion
#3	orders.status = 'Delivered' maybe needs STRCOMP instead

#DROP
drop.table.customer=\
  DROP TABLE CUSTOMER PURGE
drop.table.order=\
  DROP TABLE ORDER PURGE
drop.table.orderItem=\
  DROP TABLE ORDERITEM PURGE
drop.table.product=\
  DROP TABLE PRODUCT PURGE
drop.table.category=\
  DROP TABLE CATEGORY PURGE

